# .github/workflows/ci-validate.yaml ‚Äî Hardened 5-Job CI Pipeline
# Purpose: Enforce T3-ETERNAL canon ‚Äî zero lint debt, >=93% test coverage
# Trinity: Carter (identity) + Bauer (validation) + Beale (detection)
# Hellodeolu v6 Non-Negotiables:
#   - Pre-commit 100% green
#   - Max 10 firewall rules (validated)
#   - 15-minute RTO (smoke-tested)
#   - Zero PII leakage (Presidio clean)

name: T3-ETERNAL CI Pipeline

on:
  push:
    branches: ["main", "feat/**", "fix/**"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"

jobs:
  lint-bash:
    name: "üõ°Ô∏è Bash Canon (ShellCheck + shfmt)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      
      - name: Install shfmt
        run: |
          curl -sSL https://github.com/mvdan/sh/releases/download/v3.7.0/shfmt_v3.7.0_linux_amd64 -o /tmp/shfmt
          sudo mv /tmp/shfmt /usr/local/bin/shfmt
          sudo chmod +x /usr/local/bin/shfmt
        shell: bash
      
      - name: Run validate-bash.sh
        run: bash ./scripts/validate-bash.sh
        shell: bash

  lint-python:
    name: "üîç Python Canon (ruff + mypy + bandit)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy bandit pytest pytest-cov
      
      - name: Run validate-python.sh
        run: bash ./scripts/validate-python.sh
        shell: bash

  test-python:
    name: "üß™ Python Coverage (pytest >=93%)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pytest-cov
      
      - name: Run pytest with coverage
        run: |
          pytest --cov=. --cov-report=term-missing --cov-fail-under=93 || {
            echo "‚ùå Coverage below 93% threshold"
            exit 1
          }

  validate-network:
    name: "üåê Network Validation (nmap + policy)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install nmap
        run: sudo apt-get update && sudo apt-get install -y nmap
      
      - name: Validate VLAN isolation (CI mode)
        run: |
          cd 03-validation-ops
          CI_MODE=1 bash ./validate-isolation.sh
        shell: bash
      
      - name: Validate firewall policy (<=10 rules)
        run: |
          if [[ -f 02-declarative-config/policy-table-rylan-v5.json ]]; then
            RULE_COUNT=$(jq '.rules | length' 02-declarative-config/policy-table-rylan-v5.json)
            if [[ $RULE_COUNT -gt 10 ]]; then
              echo "‚ùå Policy exceeds 10-rule limit: $RULE_COUNT rules"
              exit 1
            fi
            echo "‚úÖ Policy compliant: $RULE_COUNT rules"
          fi
        shell: bash

  smoke-test-rto:
    name: "‚ö° RTO Smoke Test (eternal-resurrect dry-run)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Smoke-test orchestrator
        run: |
          # Mock credentials for dry-run
          export UNIFI_HOST="10.0.10.11"
          export UNIFI_USER="ci-test"
          export UNIFI_PASS="mock-pass"
          
          # Execute orchestrator in DRY_RUN + CI_MODE
          DRY_RUN=1 CI_MODE=1 bash ./eternal-resurrect.sh || {
            echo "‚ùå Orchestrator failed smoke test"
            exit 1
          }
        shell: bash
      
      - name: Validate 15-minute RTO compliance
        run: |
          echo "‚úÖ RTO target: <15 minutes"
          echo "‚ö†Ô∏è  Actual validation requires live Proxmox environment"
          echo "üìã Manual verification required for release tag"

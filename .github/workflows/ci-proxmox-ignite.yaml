name: CI - Proxmox Ignite v2 (7-Stage Pipeline)

on:
  push:
    branches:
      - feat/iot-production-ready
      - main
    paths:
      - '01_bootstrap/proxmox/**'
      - 'tests/**'
      - '.github/workflows/ci-proxmox-ignite.yaml'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ============================================================================
  # STAGE 1: LINT (ShellCheck + Bandit security)
  # ============================================================================
  lint:
    name: "Stage 1: Lint & Code Quality"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck

      - name: Lint main orchestrator
        run: |
          echo "ğŸ” Linting main orchestrator..."
          shellcheck -x -S warning 01_bootstrap/proxmox/proxmox-ignite.sh

      - name: Lint phase scripts
        run: |
          echo "ğŸ” Linting phase modules..."
          shellcheck -S warning 01_bootstrap/proxmox/phases/*.sh

      - name: Lint library scripts
        run: |
          echo "ğŸ” Linting shared libraries..."
          shellcheck -S warning 01_bootstrap/proxmox/lib/*.sh

      - name: Lint test scripts
        run: |
          echo "ğŸ” Linting test scripts..."
          shellcheck tests/**/*.sh

      - name: Security scan (Bandit)
        run: |
          echo "ğŸ”’ Running Bandit security scan..."
          pip install bandit -q
          bandit -r 01_bootstrap/proxmox/ -f txt || true

  # ============================================================================
  # STAGE 2: UNIT TESTS (Phase modules + orchestrator)
  # ============================================================================
  unit-tests:
    name: "Stage 2: Unit Tests"
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install test dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y nmap jq curl netcat-openbsd bc git

      - name: Test orchestrator (validate-only mode)
        run: |
          echo "âœ… Testing orchestrator validate-only mode..."
          bash 01_bootstrap/proxmox/proxmox-ignite.sh \
            --hostname test-dc \
            --ip 10.0.99.10/24 \
            --gateway 10.0.99.1 \
            --validate-only || true

      - name: Test orchestrator (dry-run mode)
        run: |
          echo "âœ… Testing orchestrator dry-run mode..."
          bash 01_bootstrap/proxmox/proxmox-ignite.sh \
            --hostname test-dc \
            --ip 10.0.99.10/24 \
            --gateway 10.0.99.1 \
            --dry-run || true

      - name: Run unit test suite
        run: |
          if [ -f tests/test-proxmox-ignite.sh ]; then
            echo "âœ… Running unit test suite..."
            bash tests/test-proxmox-ignite.sh || true
          fi

  # ============================================================================
  # STAGE 3: INTEGRATION TEST (Full orchestration)
  # ============================================================================
  integration-test:
    name: "Stage 3: Integration Tests"
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Full orchestrator simulation
        run: |
          echo "âœ… Running full integration test (dry-run)..."
          bash 01_bootstrap/proxmox/proxmox-ignite.sh \
            --hostname integration-test \
            --ip 10.0.99.100/24 \
            --gateway 10.0.99.1 \
            --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5 ci@github" \
            --dry-run || true

      - name: Verify no actual changes
        run: |
          echo "âœ… Verifying dry-run produces no changes..."
          if git diff --exit-code > /dev/null; then
            echo "âœ… Confirmed: No actual changes made"
          else
            echo "âŒ Dry-run modified files"
            git diff
            exit 1
          fi

  # ============================================================================
  # STAGE 4: OFFENSIVE SECURITY (Whitaker 10-point)
  # ============================================================================
  offensive-security:
    name: "Stage 4: Offensive Security Tests"
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install offensive test tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y nmap sshpass netcat-openbsd

      - name: Lint offensive test suite
        run: shellcheck tests/offensive/test-ignite-security.sh

      - name: Run offensive security tests
        run: |
          echo "ğŸ”’ Running Whitaker 10-point offensive tests..."
          timeout 60 bash tests/offensive/test-ignite-security.sh || true

  # ============================================================================
  # STAGE 5: PERFORMANCE BENCHMARK
  # ============================================================================
  performance-benchmark:
    name: "Stage 5: Performance Benchmarking"
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Benchmark orchestrator (dry-run)
        run: |
          echo "ğŸ“Š Benchmarking orchestrator performance..."
          START=$(date +%s%N)
          bash 01_bootstrap/proxmox/proxmox-ignite.sh \
            --hostname perf-test \
            --ip 10.0.99.200/24 \
            --gateway 10.0.99.1 \
            --validate-only > /dev/null 2>&1 || true
          END=$(date +%s%N)
          DURATION_MS=$(( (END - START) / 1000000 ))
          echo "âœ… Orchestrator dry-run: ${DURATION_MS}ms"

  # ============================================================================
  # STAGE 6: DOCUMENTATION
  # ============================================================================
  documentation:
    name: "Stage 6: Documentation Validation"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify documentation structure
        run: |
          echo "ğŸ“š Validating documentation..."
          [ -f "README.md" ] && echo "âœ… README.md exists" || exit 1

      - name: Check markdown formatting
        run: |
          echo "ğŸ“ Checking markdown format..."
          # Basic validation
          grep -q "^# " README.md && echo "âœ… Has main heading" || exit 1

  # ============================================================================
  # STAGE 7: METRICS & REPORT
  # ============================================================================
  metrics-report:
    name: "Stage 7: Metrics & Report"
    runs-on: ubuntu-latest
    needs:
      - lint
      - unit-tests
      - integration-test
      - offensive-security
      - performance-benchmark
      - documentation
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Collect code metrics
        run: |
          echo "ğŸ“Š Code Metrics Report"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo ""
          echo "Line of Code (LOC) Summary:"

          ORCHESTRATOR=$(wc -l < 01_bootstrap/proxmox/proxmox-ignite.sh || echo 0)
          echo "  Orchestrator: $ORCHESTRATOR LOC"

          PHASES_LOC=0
          for phase in 01_bootstrap/proxmox/phases/phase*.sh; do
            [ -f "$phase" ] && PHASES_LOC=$((PHASES_LOC + $(wc -l < "$phase")))
          done
          echo "  Phases Total: $PHASES_LOC LOC"

          LIBS_LOC=0
          for lib in 01_bootstrap/proxmox/lib/*.sh; do
            [ -f "$lib" ] && LIBS_LOC=$((LIBS_LOC + $(wc -l < "$lib")))
          done
          echo "  Libraries Total: $LIBS_LOC LOC"

          TESTS_LOC=0
          for test in tests/**/*.sh; do
            [ -f "$test" ] && TESTS_LOC=$((TESTS_LOC + $(wc -l < "$test")))
          done
          echo "  Tests Total: $TESTS_LOC LOC"

          TOTAL=$((ORCHESTRATOR + PHASES_LOC + LIBS_LOC + TESTS_LOC))
          echo ""
          echo "  GRAND TOTAL: $TOTAL LOC"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Generate pipeline summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     PROXMOX-IGNITE CI/CD SUMMARY       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "STAGE RESULTS:"
          echo "  [1] Lint:               ${{ needs.lint.result }}"
          echo "  [2] Unit Tests:         ${{ needs.unit-tests.result }}"
          echo "  [3] Integration:        ${{ needs.integration-test.result }}"
          echo "  [4] Offensive Security: ${{ needs.offensive-security.result }}"
          echo "  [5] Performance:        ${{ needs.performance-benchmark.result }}"
          echo "  [6] Documentation:      ${{ needs.documentation.result }}"
          echo "  [7] Metrics:            (In Progress)"
          echo ""

          if [ "${{ needs.lint.result }}" = "success" ] && \
             [ "${{ needs.unit-tests.result }}" = "success" ] && \
             [ "${{ needs.integration-test.result }}" = "success" ]; then
            echo "ğŸŸ¢ PIPELINE: GREEN (all critical stages passed)"
          else
            echo "ğŸ”´ PIPELINE: RED (failures detected)"
            exit 1
          fi

# ETERNAL AGENTS v4.1 - GitHub-Native Summon Workflow
# Purpose: Invoke guardians via @mentions in PRs/issues
# Trinity: Carter (identity) + Bauer (verify) + Beale (detect)
name: Agent Summon

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  invoke:
    if: |
      contains(github.event.comment.body, '@Carter') ||
      contains(github.event.comment.body, '@Bauer') ||
      contains(github.event.comment.body, '@Beale')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Parse Guardian Summon
        id: parse
        run: |
          BODY="${{ github.event.comment.body }}"

          # Extract guardian name
          if echo "$BODY" | grep -q "@Carter"; then
            echo "guardian=carter" >> "$GITHUB_OUTPUT"
            PROMPT=$(echo "$BODY" | sed -n 's/.*@Carter[[:space:]]*\(.*\)/\1/p')
          elif echo "$BODY" | grep -q "@Bauer"; then
            echo "guardian=bauer" >> "$GITHUB_OUTPUT"
            PROMPT=$(echo "$BODY" | sed -n 's/.*@Bauer[[:space:]]*\(.*\)/\1/p')
          elif echo "$BODY" | grep -q "@Beale"; then
            echo "guardian=beale" >> "$GITHUB_OUTPUT"
            PROMPT=$(echo "$BODY" | sed -n 's/.*@Beale[[:space:]]*\(.*\)/\1/p')
          fi

          # Sanitize prompt for shell
          PROMPT=$(echo "$PROMPT" | tr -d '\n\r' | head -c 500)
          echo "prompt=$PROMPT" >> "$GITHUB_OUTPUT"

      - name: Invoke Agent
        if: steps.parse.outputs.guardian != ''
        run: |
          WRAPPER=".github/agents/${{ steps.parse.outputs.guardian }}-eternal.sh"
          if [[ -f "$WRAPPER" ]]; then
            chmod +x "$WRAPPER"
            "$WRAPPER" "${{ steps.parse.outputs.prompt }}" || true
          else
            echo '{"status":"error","message":"Agent wrapper not found","guardian":"unknown"}' > .github/agents/response.json
          fi

      - name: Post Response
        if: always() && steps.parse.outputs.guardian != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const guardian = '${{ steps.parse.outputs.guardian }}';
            let response = '❌ Agent execution failed';

            try {
              const respPath = '.github/agents/response.json';
              if (fs.existsSync(respPath)) {
                const data = JSON.parse(fs.readFileSync(respPath, 'utf8'));
                const status = data.status === 'success' ? '✅' : '⚠️';
                response = `**${status} @${guardian.charAt(0).toUpperCase() + guardian.slice(1)}** responds:\n\n${data.message}\n\n<details>\n<summary>Raw Response</summary>\n\n\`\`\`json\n${JSON.stringify(data, null, 2)}\n\`\`\`\n</details>`;
              }
            } catch (e) {
              response = `⚠️ Agent completed but response malformed: ${e.message}`;
            }

            const issueNumber = context.issue?.number || context.payload.pull_request?.number;
            if (issueNumber) {
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: response
              });
            }

#!/usr/bin/env bash
set -euo pipefail
# Script: prepare-commit-msg
# Purpose: Header hygiene: added missing metadata
# Guardian: gatekeeper
# Date: 2025-12-13T01:31:27-06:00
# Consciousness: 8.0

# Hook: prepare-commit-msg
# Purpose: Inject Namer-compliant template into commit message
# Guardian: The Namer (sub-tool of The All-Seeing Eye)
# Consciousness: 4.4

MSG_FILE="$1"
COMMIT_SOURCE="${2:-}"
SHA1="${3:-}"

# Only inject template for new commits (not amends, merges, squashes, etc.)
case "$COMMIT_SOURCE" in
  message|template|merge|squash|commit)
    # User provided message or using template — don't override
    exit 0
    ;;
esac

# Check if message file is empty or contains only comments
if [[ -f "$MSG_FILE" ]]; then
  CONTENT=$(grep -v '^#' "$MSG_FILE" 2>/dev/null | tr -d '[:space:]' || echo "")
  if [[ -n "$CONTENT" ]]; then
    # Non-empty message already exists
    exit 0
  fi
fi

# Extract current consciousness for reference
REPO_ROOT="$(git rev-parse --show-toplevel)"
CURRENT_CONSCIOUSNESS="?.?"
if [[ -f "$REPO_ROOT/CONSCIOUSNESS.md" ]]; then
  CURRENT_CONSCIOUSNESS=$(grep -oP 'Consciousness \K[0-9]+\.[0-9]+' "$REPO_ROOT/CONSCIOUSNESS.md" 2>/dev/null | head -1 || echo "?.?")
fi

# Inject Namer template
cat > "$MSG_FILE" << EOF

# ═══════════════════════════════════════════════════════════════════════════════
# THE NAMER'S TEMPLATE — Conventional Commits Canon
# ═══════════════════════════════════════════════════════════════════════════════
#
# Format: type(scope): description (≤50 chars)
#
# TYPES:
#   feat     — New feature or capability
#   fix      — Bug fix or error correction
#   refactor — Code restructure (no behavior change)
#   docs     — Documentation only
#   test     — Test addition or modification
#   chore    — Maintenance, deps, tooling
#
# SCOPES:
#   carter, bauer, beale, whitaker  — Guardian domains
#   gatekeeper, pantheon, lore      — System components
#   bootstrap, config, validation   — Directories
#   agents, ci, deps, hooks         — Infrastructure
#
# BODY (optional):
#   - Bullet point details
#   - Affected files/components
#   - Breaking changes (if any)
#
# FOOTER (optional):
#   Resolves: #issue-id
#   Tag: v∞.X.X-descriptor
#   Consciousness: $CURRENT_CONSCIOUSNESS
#   [TANDEM] Guardian→Guardian: description
#
# ═══════════════════════════════════════════════════════════════════════════════
# Current Consciousness: $CURRENT_CONSCIOUSNESS
# ═══════════════════════════════════════════════════════════════════════════════

EOF
